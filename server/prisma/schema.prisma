// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model News {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text // 允许长文本
  cover       String   // 封面图片 URL
  date        String   // 显示日期，如 "2025-10-20"
  link        String   // 跳转链接
  isPinned    Boolean  @default(false) // 是否置顶
  pinTime     DateTime? // 置顶时间，用于排序
  createdAt   DateTime @default(now())
}

// 1. 赛事表
model Tournament {
  id        String   @id @default(uuid())
  name      String
  dateRange String
  stages    Stage[]  
  matches   Match[]  
  players   PlayerStat[] 
}

// 2. 阶段表
model Stage {
  id           String     @id @default(uuid())
  name         String
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches      Match[]
  players      PlayerStat[]
}

// 3. 比赛表
model Match {
  id           String     @id // 使用完美平台的 RoomID
  teamA        String
  teamB        String
  scoreA       Int
  scoreB       Int
  status       String     
  bo           Int
  streamUrl    String?    
  currentMap   String?
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])

  maps         Json?       
  
  createdAt    DateTime @default(now())
}

// 4. 选手数据表
model PlayerStat {
  id           String   @id 
  steamId      String?
  name         String
  team         String
  rating       String
  adr          String
  kd           String
  hs           String
  maps         Int
  rws          String?  // Round Win Shares
  fk           String?  // First Kills
  hsVal        Float?   // 数值型爆头率 (用于雷达图)
  
  originalId   String?  // 保留原始ID字段方便迁移
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])
}

// 5. 其他表
model Announcement {
  id      String @id @default(uuid())
  date    String
  content String @db.Text
  style   Json?  
}

model SiteConfig {
  id                 Int @id @default(1)
  heroTitle          String?
  heroSubtitle       String?
  heroDate           String?
  prizePool          String?
  prizeGoal          Int?
  newsTicker         Json?
  aboutText          String? @db.Text
  featuredTournamentId String?
}

model HistoryTournament {
  id        String @id @default(uuid())
  name      String
  year      String
  champion  Json 
  finalist  String
  semis     Json 
  quarters  Json 
}


model User {
  id          String   @id @default(uuid())
  username    String   @unique // 登录账号 (唯一，不可重复)
  password    String   // 加密后的密码
  role        String   @default("user")
  name        String   @unique // 用户昵称 (用于显示，可以修改)
  email       String?  @unique // 邮箱 (可选)
  forceUpdate Boolean  @default(false)
}


model Feedback {
  id      String @id @default(uuid())
  user    String
  userId  String?
  content String @db.Text
  qq      String?
  date    String
}

// --- 竞猜系统 (Pick'Em) ---

// 1. 竞猜活动主表 (对应某个赛事的某个阶段)
model PickemEvent {
  id           String   @id @default(uuid())
  tournamentId String   // 关联现有 Tournament
  stageId      String   // 关联现有 Stage
  type         String   // "SWISS" (瑞士轮) 或 "SINGLE_ELIM" (单败淘汰)
  status       String   @default("PENDING") // PENDING(未开始), OPEN(开放竞猜), LOCKED(锁定/进行中), FINISHED(已结算)
  deadline     DateTime? // [新增] 截止时间
  isVisible    Boolean  @default(true)
  
  // 专属于此阶段的 16支 (或8支) 战队快照
  teams        PickemTeam[]
  // 此阶段生成的所有对阵 (轮次动态生成)
  matches      PickemMatch[]

  
  createdAt    DateTime @default(now())
}

// 2. 竞猜战队 (带种子顺位和实时战绩)
model PickemTeam {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name         String      // 战队名 (快照)
  seed         Int         // 初始种子排名 (1-16)
  
  // 实时状态 (由管理员录入比赛结果后自动更新)
  wins         Int         @default(0)
  losses       Int         @default(0)
  buchholz     Int         @default(0) // BU分 (动态计算)
  roundDiff    Int         @default(0) // 净胜分 (辅助排序)
  status       String      @default("ALIVE") // ALIVE(存活), ADVANCED(晋级 3-0/3-1/3-2), ELIMINATED(淘汰 0-3/1-3/2-3)
}

// 3. 竞猜对阵 (由算法自动生成)
model PickemMatch {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  round        Int         // 轮次: 1, 2, 3, 4, 5 (瑞士轮) 或 8, 4, 2, 1 (淘汰赛代表几强)
  matchGroup   String?     // 分组标识: "2-0", "1-1", "0-2" 等 (方便前端通过分组显示)
  isBo3        Boolean     @default(false)
  isFinished   Boolean     @default(false)

  teamAId      String?     // 关联 PickemTeam (如果轮空则可能为空，虽瑞士轮一般无轮空)
  teamBId      String?
  
  // 结果录入
  scoreA       Int         @default(0) // 大比分 (e.g., 2)
  scoreB       Int         @default(0) // 大比分 (e.g., 1)
  winnerId     String?     // 胜者ID (用于晋级判断)
  
  // 详细小分 (用于 BO3 或 BO1 显示)
  // 格式: [{"map": "Mirage", "scoreA": 13, "scoreB": 9}, ...]
  mapDetails   Json?       
}

model UserPick {
  id           String      @id @default(uuid())
  userId       String
  eventId      String
  

  
  pick30       Json?       
  pick03       Json?       
  pickAdvance  Json?       
  bracketPicks Json?       
  
  isLocked     Boolean     @default(false)
  coinLevel    String      @default("BRONZE")
  correctCount Int         @default(0)
  
  updatedAt    DateTime    @updatedAt
}