// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model News {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text // å…è®¸é•¿æ–‡æœ¬
  cover       String   // å°é¢å›¾ç‰‡ URL
  date        String   // æ˜¾ç¤ºæ—¥æœŸï¼Œå¦‚ "2025-10-20"
  link        String   // è·³è½¬é“¾æ¥
  isPinned    Boolean  @default(false) // æ˜¯å¦ç½®é¡¶
  pinTime     DateTime? // ç½®é¡¶æ—¶é—´ï¼Œç”¨äºæ’åº
  createdAt   DateTime @default(now())
}

// 1. èµ›äº‹è¡¨ (ä¿®æ”¹)
model Tournament {
  id                 String   @id @default(uuid())
  name               String
  dateRange          String
  // ğŸ‘‡ [æ–°å¢] å¿…é¡»åŠ è¿™è¡Œï¼Œå¦åˆ™çŠ¶æ€å­˜ä¸è¿›å»ï¼
  registrationStatus String   @default("NOT_STARTED") 
  
  stages             Stage[]  
  matches            Match[]  
  players            PlayerStat[] 
  
  // ğŸ‘‡ [æ–°å¢] å…³è”æˆ˜é˜Ÿå’Œæ•£äºº (å¦‚æœä½ ä¹‹å‰åŠ äº† Team è¡¨ï¼Œè¿™é‡Œå¿…é¡»å…³è”)
  teams              Team[]
  freeAgents         FreeAgent[]
}

// [æ–°å¢] 2. æˆ˜é˜ŸæŠ¥åè¡¨ (Team)
model Team {
  id           String   @id @default(uuid())
  name         String
  tag          String?
  digitalId    String?  // å®Œç¾æˆ˜é˜ŸID
  contact      String?
  avgElo       String?
  logoColor    String?
  status       String   @default("pending") // pending, approved, rejected
  rejectReason String?
  ownerId      String?  // é˜Ÿé•¿ç”¨æˆ·ID
  members      Json     // æˆå‘˜åˆ—è¡¨ (å­˜ JSON æ•°ç»„)
  
  tournamentId String?  // å½’å±èµ›äº‹
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
}

// [æ–°å¢] 3. æ•£äººæŠ¥åè¡¨ (FreeAgent)
model FreeAgent {
  id           String   @id @default(uuid())
  name         String
  steamId      String?
  role         String?
  score        String?
  class        String?
  studentId    String?
  contact      String?
  ownerId      String?  // ç”¨æˆ·ID
  
  tournamentId String?  // å½’å±èµ›äº‹
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
}

// 2. é˜¶æ®µè¡¨
model Stage {
  id           String     @id @default(uuid())
  name         String
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches      Match[]
  players      PlayerStat[]
}

// 3. æ¯”èµ›è¡¨
model Match {
  id           String     @id // ä½¿ç”¨å®Œç¾å¹³å°çš„ RoomID
  teamA        String
  teamB        String
  scoreA       Int
  scoreB       Int
  status       String     
  bo           Int
  streamUrl    String?    
  currentMap   String?
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])

  maps         Json?       
  
  createdAt    DateTime @default(now())
}

// 4. é€‰æ‰‹æ•°æ®è¡¨
model PlayerStat {
  id           String   @id 
  steamId      String?
  name         String
  team         String
  rating       String
  adr          String
  kd           String
  hs           String
  maps         Int
  rws          String?  // Round Win Shares
  fk           String?  // First Kills
  hsVal        Float?   // æ•°å€¼å‹çˆ†å¤´ç‡ (ç”¨äºé›·è¾¾å›¾)
  
  originalId   String?  // ä¿ç•™åŸå§‹IDå­—æ®µæ–¹ä¾¿è¿ç§»
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])
}

// 5. å…¶ä»–è¡¨
model Announcement {
  id      String @id @default(uuid())
  date    String
  content String @db.Text
  style   Json?  
}

model SiteConfig {
  id                 Int @id @default(1)
  heroTitle          String?
  heroSubtitle       String?
  heroDate           String?
  prizePool          String?
  prizeGoal          Int?
  newsTicker         Json?
  aboutText          String? @db.Text
  featuredTournamentId String?
}

model HistoryTournament {
  id        String @id @default(uuid())
  name      String
  year      String
  champion  Json 
  finalist  String
  semis     Json 
  quarters  Json 
}


model User {
  id          String   @id @default(uuid())
  username    String   @unique // ç™»å½•è´¦å· (å”¯ä¸€ï¼Œä¸å¯é‡å¤)
  password    String   // åŠ å¯†åçš„å¯†ç 
  role        String   @default("user")
  name        String   @unique // ç”¨æˆ·æ˜µç§° (ç”¨äºæ˜¾ç¤ºï¼Œå¯ä»¥ä¿®æ”¹)
  email       String?  @unique // é‚®ç®± (å¯é€‰)
  forceUpdate Boolean  @default(false)
}


model Feedback {
  id      String @id @default(uuid())
  user    String
  userId  String?
  content String @db.Text
  qq      String?
  date    String
}

// --- ç«çŒœç³»ç»Ÿ (Pick'Em) ---

// 1. ç«çŒœæ´»åŠ¨ä¸»è¡¨ (å¯¹åº”æŸä¸ªèµ›äº‹çš„æŸä¸ªé˜¶æ®µ)
model PickemEvent {
  id           String   @id @default(uuid())
  tournamentId String   // å…³è”ç°æœ‰ Tournament
  stageId      String   // å…³è”ç°æœ‰ Stage
  type         String   // "SWISS" (ç‘å£«è½®) æˆ– "SINGLE_ELIM" (å•è´¥æ·˜æ±°)
  status       String   @default("PENDING") // PENDING(æœªå¼€å§‹), OPEN(å¼€æ”¾ç«çŒœ), LOCKED(é”å®š/è¿›è¡Œä¸­), FINISHED(å·²ç»“ç®—)
  deadline     DateTime? // [æ–°å¢] æˆªæ­¢æ—¶é—´
  isVisible    Boolean  @default(true)
  
  // ä¸“å±äºæ­¤é˜¶æ®µçš„ 16æ”¯ (æˆ–8æ”¯) æˆ˜é˜Ÿå¿«ç…§
  teams        PickemTeam[]
  // æ­¤é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰å¯¹é˜µ (è½®æ¬¡åŠ¨æ€ç”Ÿæˆ)
  matches      PickemMatch[]

  
  createdAt    DateTime @default(now())
}

// 2. ç«çŒœæˆ˜é˜Ÿ (å¸¦ç§å­é¡ºä½å’Œå®æ—¶æˆ˜ç»©)
model PickemTeam {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name         String      // æˆ˜é˜Ÿå (å¿«ç…§)
  seed         Int         // åˆå§‹ç§å­æ’å (1-16)
  
  // å®æ—¶çŠ¶æ€ (ç”±ç®¡ç†å‘˜å½•å…¥æ¯”èµ›ç»“æœåè‡ªåŠ¨æ›´æ–°)
  wins         Int         @default(0)
  losses       Int         @default(0)
  buchholz     Int         @default(0) // BUåˆ† (åŠ¨æ€è®¡ç®—)
  roundDiff    Int         @default(0) // å‡€èƒœåˆ† (è¾…åŠ©æ’åº)
  status       String      @default("ALIVE") // ALIVE(å­˜æ´»), ADVANCED(æ™‹çº§ 3-0/3-1/3-2), ELIMINATED(æ·˜æ±° 0-3/1-3/2-3)
}

// 3. ç«çŒœå¯¹é˜µ (ç”±ç®—æ³•è‡ªåŠ¨ç”Ÿæˆ)
model PickemMatch {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  round        Int         // è½®æ¬¡: 1, 2, 3, 4, 5 (ç‘å£«è½®) æˆ– 8, 4, 2, 1 (æ·˜æ±°èµ›ä»£è¡¨å‡ å¼º)
  matchGroup   String?     // åˆ†ç»„æ ‡è¯†: "2-0", "1-1", "0-2" ç­‰ (æ–¹ä¾¿å‰ç«¯é€šè¿‡åˆ†ç»„æ˜¾ç¤º)
  isBo3        Boolean     @default(false)
  isFinished   Boolean     @default(false)

  teamAId      String?     // å…³è” PickemTeam (å¦‚æœè½®ç©ºåˆ™å¯èƒ½ä¸ºç©ºï¼Œè™½ç‘å£«è½®ä¸€èˆ¬æ— è½®ç©º)
  teamBId      String?
  
  // ç»“æœå½•å…¥
  scoreA       Int         @default(0) // å¤§æ¯”åˆ† (e.g., 2)
  scoreB       Int         @default(0) // å¤§æ¯”åˆ† (e.g., 1)
  winnerId     String?     // èƒœè€…ID (ç”¨äºæ™‹çº§åˆ¤æ–­)
  
  // è¯¦ç»†å°åˆ† (ç”¨äº BO3 æˆ– BO1 æ˜¾ç¤º)
  // æ ¼å¼: [{"map": "Mirage", "scoreA": 13, "scoreB": 9}, ...]
  mapDetails   Json?       
}

model UserPick {
  id           String      @id @default(uuid())
  userId       String
  eventId      String
  

  
  pick30       Json?       
  pick03       Json?       
  pickAdvance  Json?       
  bracketPicks Json?       
  
  isLocked     Boolean     @default(false)
  coinLevel    String      @default("BRONZE")
  correctCount Int         @default(0)
  
  updatedAt    DateTime    @updatedAt
}