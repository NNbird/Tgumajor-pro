// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model News {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text // å…è®¸é•¿æ–‡æœ¬
  cover       String   // å°é¢å›¾ç‰‡ URL
  date        String   // æ˜¾ç¤ºæ—¥æœŸï¼Œå¦‚ "2025-10-20"
  link        String   // è·³è½¬é“¾æ¥
  isPinned    Boolean  @default(false) // æ˜¯å¦ç½®é¡¶
  pinTime     DateTime? // ç½®é¡¶æ—¶é—´ï¼Œç”¨äºæ’åº
  createdAt   DateTime @default(now())
}

// 1. èµ›äº‹è¡¨ (ä¿®æ”¹)
model Tournament {
  id                 String   @id @default(uuid())
  name               String
  dateRange          String
  // ğŸ‘‡ [æ–°å¢] å¿…é¡»åŠ è¿™è¡Œï¼Œå¦åˆ™çŠ¶æ€å­˜ä¸è¿›å»ï¼
  registrationStatus String   @default("NOT_STARTED") 
  
  stages             Stage[]  
  matches            Match[]  
  players            PlayerStat[] 
  
  // ğŸ‘‡ [æ–°å¢] å…³è”æˆ˜é˜Ÿå’Œæ•£äºº (å¦‚æœä½ ä¹‹å‰åŠ äº† Team è¡¨ï¼Œè¿™é‡Œå¿…é¡»å…³è”)
  teams              Team[]
  freeAgents         FreeAgent[]
}

// [æ–°å¢] 2. æˆ˜é˜ŸæŠ¥åè¡¨ (Team)
model Team {
  id           String   @id @default(uuid())
  name         String
  tag          String?
  digitalId    String?  // å®Œç¾æˆ˜é˜ŸID
  contact      String?
  avgElo       String?
  logoColor    String?
  status       String   @default("pending") // pending, approved, rejected
  rejectReason String?
  ownerId      String?  // é˜Ÿé•¿ç”¨æˆ·ID
  members      Json     // æˆå‘˜åˆ—è¡¨ (å­˜ JSON æ•°ç»„)
  
  tournamentId String?  // å½’å±èµ›äº‹
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
}

// [æ–°å¢] 3. æ•£äººæŠ¥åè¡¨ (FreeAgent)
model FreeAgent {
  id           String   @id @default(uuid())
  name         String
  steamId      String?
  role         String?
  score        String?
  class        String?
  studentId    String?
  contact      String?
  ownerId      String?  // ç”¨æˆ·ID
  
  tournamentId String?  // å½’å±èµ›äº‹
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
}

// 2. é˜¶æ®µè¡¨
model Stage {
  id           String     @id @default(uuid())
  name         String
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches      Match[]
  players      PlayerStat[]
}

// 3. æ¯”èµ›è¡¨
model Match {
  id           String     @id // ä½¿ç”¨å®Œç¾å¹³å°çš„ RoomID
  teamA        String
  teamB        String
  scoreA       Int
  scoreB       Int
  status       String     
  bo           Int
  streamUrl    String?    
  currentMap   String?
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])

  maps         Json?       
  
  createdAt    DateTime @default(now())
}

// 4. é€‰æ‰‹æ•°æ®è¡¨
model PlayerStat {
  id           String   @id 
  steamId      String?
  name         String
  team         String
  rating       String
  adr          String
  kd           String
  hs           String
  maps         Int
  rws          String?  // Round Win Shares
  fk           String?  // First Kills
  hsVal        Float?   // æ•°å€¼å‹çˆ†å¤´ç‡ (ç”¨äºé›·è¾¾å›¾)
  
  originalId   String?  // ä¿ç•™åŸå§‹IDå­—æ®µæ–¹ä¾¿è¿ç§»
  
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  stageId      String?
  stage        Stage?      @relation(fields: [stageId], references: [id])
}

// 5. å…¶ä»–è¡¨
model Announcement {
  id      String @id @default(uuid())
  date    String
  content String @db.Text
  style   Json?  
}

model SiteConfig {
  id                 Int @id @default(1)
  heroTitle          String?
  heroSubtitle       String?
  heroDate           String?
  prizePool          String?
  prizeGoal          Int?
  newsTicker         Json?
  aboutText          String? @db.Text
  featuredTournamentId String?
}

model HistoryTournament {
  id        String @id @default(uuid())
  name      String
  year      String
  champion  Json 
  finalist  String
  semis     Json 
  quarters  Json 
}


model User {
  id          String   @id @default(uuid())
  username    String   @unique // ç™»å½•è´¦å· (å”¯ä¸€ï¼Œä¸å¯é‡å¤)
  password    String   // åŠ å¯†åçš„å¯†ç 
  role        String   @default("user")
  name        String   @unique // ç”¨æˆ·æ˜µç§° (ç”¨äºæ˜¾ç¤ºï¼Œå¯ä»¥ä¿®æ”¹)
  email       String?  @unique // é‚®ç®± (å¯é€‰)
  forceUpdate Boolean  @default(false)
  teamMemberships TeamMembership[] // [æ–°å¢] å…³è”å­—æ®µ
  // [æ–°å¢] èµ„äº§ç›¸å…³å­—æ®µ
  generationCredits Int @default(3)     // å‰©ä½™ç”Ÿæˆæ¬¡æ•° (é»˜è®¤ä¸º3)
  assets            UserAsset[]         // ä¸ªäººèƒŒåŒ…
  generationTasks   GenerationTask[]    // ç”Ÿæˆä»»åŠ¡è®°å½•
}


model Feedback {
  id      String @id @default(uuid())
  user    String
  userId  String?
  content String @db.Text
  qq      String?
  date    String
}

// --- ç«çŒœç³»ç»Ÿ (Pick'Em) ---

// 1. ç«çŒœæ´»åŠ¨ä¸»è¡¨ (å¯¹åº”æŸä¸ªèµ›äº‹çš„æŸä¸ªé˜¶æ®µ)
model PickemEvent {
  id           String   @id @default(uuid())
  tournamentId String   // å…³è”ç°æœ‰ Tournament
  stageId      String   // å…³è”ç°æœ‰ Stage
  type         String   // "SWISS" (ç‘å£«è½®) æˆ– "SINGLE_ELIM" (å•è´¥æ·˜æ±°)
  status       String   @default("PENDING") // PENDING(æœªå¼€å§‹), OPEN(å¼€æ”¾ç«çŒœ), LOCKED(é”å®š/è¿›è¡Œä¸­), FINISHED(å·²ç»“ç®—)
  deadline     DateTime? // [æ–°å¢] æˆªæ­¢æ—¶é—´
  isVisible    Boolean  @default(true)
  
  // ä¸“å±äºæ­¤é˜¶æ®µçš„ 16æ”¯ (æˆ–8æ”¯) æˆ˜é˜Ÿå¿«ç…§
  teams        PickemTeam[]
  // æ­¤é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰å¯¹é˜µ (è½®æ¬¡åŠ¨æ€ç”Ÿæˆ)
  matches      PickemMatch[]

  
  createdAt    DateTime @default(now())
}

// 2. ç«çŒœæˆ˜é˜Ÿ (å¸¦ç§å­é¡ºä½å’Œå®æ—¶æˆ˜ç»©)
model PickemTeam {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name         String      // æˆ˜é˜Ÿå (å¿«ç…§)
  seed         Int         // åˆå§‹ç§å­æ’å (1-16)
  
  // å®æ—¶çŠ¶æ€ (ç”±ç®¡ç†å‘˜å½•å…¥æ¯”èµ›ç»“æœåè‡ªåŠ¨æ›´æ–°)
  wins         Int         @default(0)
  losses       Int         @default(0)
  buchholz     Int         @default(0) // BUåˆ† (åŠ¨æ€è®¡ç®—)
  roundDiff    Int         @default(0) // å‡€èƒœåˆ† (è¾…åŠ©æ’åº)
  status       String      @default("ALIVE") // ALIVE(å­˜æ´»), ADVANCED(æ™‹çº§ 3-0/3-1/3-2), ELIMINATED(æ·˜æ±° 0-3/1-3/2-3)
}

// 3. ç«çŒœå¯¹é˜µ (ç”±ç®—æ³•è‡ªåŠ¨ç”Ÿæˆ)
model PickemMatch {
  id           String      @id @default(uuid())
  eventId      String
  event        PickemEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  round        Int         // è½®æ¬¡: 1, 2, 3, 4, 5 (ç‘å£«è½®) æˆ– 8, 4, 2, 1 (æ·˜æ±°èµ›ä»£è¡¨å‡ å¼º)
  matchGroup   String?     // åˆ†ç»„æ ‡è¯†: "2-0", "1-1", "0-2" ç­‰ (æ–¹ä¾¿å‰ç«¯é€šè¿‡åˆ†ç»„æ˜¾ç¤º)
  isBo3        Boolean     @default(false)
  isFinished   Boolean     @default(false)

  teamAId      String?     // å…³è” PickemTeam (å¦‚æœè½®ç©ºåˆ™å¯èƒ½ä¸ºç©ºï¼Œè™½ç‘å£«è½®ä¸€èˆ¬æ— è½®ç©º)
  teamBId      String?
  
  // ç»“æœå½•å…¥
  scoreA       Int         @default(0) // å¤§æ¯”åˆ† (e.g., 2)
  scoreB       Int         @default(0) // å¤§æ¯”åˆ† (e.g., 1)
  winnerId     String?     // èƒœè€…ID (ç”¨äºæ™‹çº§åˆ¤æ–­)
  
  // è¯¦ç»†å°åˆ† (ç”¨äº BO3 æˆ– BO1 æ˜¾ç¤º)
  // æ ¼å¼: [{"map": "Mirage", "scoreA": 13, "scoreB": 9}, ...]
  mapDetails   Json?       
}

model UserPick {
  id           String      @id @default(uuid())
  userId       String
  eventId      String
  

  
  pick30       Json?       
  pick03       Json?       
  pickAdvance  Json?       
  bracketPicks Json?       
  
  isLocked     Boolean     @default(false)
  coinLevel    String      @default("BRONZE")
  correctCount Int         @default(0)
  
  updatedAt    DateTime    @updatedAt
}

// [New Model] æˆ˜é˜Ÿæˆå‘˜å…³ç³»è¡¨
model TeamMembership {
  id        Int      @id @default(autoincrement())
  userId    String   // æ³¨æ„ï¼šUserè¡¨çš„IDæ˜¯String(uuid)ï¼Œè¿™é‡Œå¿…é¡»å¯¹åº”
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  teamName  String   // ç»‘å®šæˆ˜é˜Ÿåç§° (è§†ä¸ºå”¯ä¸€æ ‡è¯†)
  role      String   // 'CAPTAIN', 'MEMBER', 'MANAGER', 'COACH'
  status    String   @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED'
  
  createdAt DateTime @default(now())

  // è”åˆå”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿ä¸€ä¸ªç”¨æˆ·åœ¨åŒä¸€ä¸ªæˆ˜é˜Ÿåªæœ‰ä¸€æ¡è®°å½• (æˆ–è€…å…¨å±€å”¯ä¸€ï¼Œçœ‹ä¸šåŠ¡éœ€æ±‚ï¼Œè¿™é‡Œå»ºè®®å…¨å±€å”¯ä¸€)
  @@unique([userId]) // å¼ºåˆ¶ç”¨æˆ·åŒä¸€æ—¶é—´åªèƒ½åŠ å…¥ä¸€ä¸ªæˆ˜é˜Ÿ
}

// [Modified] å…¨å±€æˆ˜é˜Ÿä¸»æ¡£
model EsportsTeam {
  id          Int      @id @default(autoincrement())
  name        String   @unique 
  logo        String?  
  description String?  
  isVerified  Boolean  @default(true) 
  
  // [æ–°å¢] æˆ˜é˜Ÿè£èª‰èµ„äº§
  assets            UserAsset[]         // æˆ˜é˜Ÿä»“åº“ (å­˜æ”¾å¥–æ¯ç­‰)
  
  // --- ğŸ¤– å‰ç¥¥ç‰©å·¥åŠå­—æ®µ (Mascot Workshop) ---
  mascotPrompt     String?  @db.Text // ç”¨æˆ·çš„åŸå§‹åˆ›æ„
  mascot2DUrl      String?  // æœ¬åœ° 2D è®¾è®¡å›¾è·¯å¾„ (e.g., /3Dmodels/Navi/date.png)
  mascot3DUrl      String?  // æœ¬åœ° 3D æ¨¡å‹è·¯å¾„ (e.g., /3Dmodels/Navi/date.glb)
  mascotStatus     String   @default("NONE") // NONE, GEN_2D, WAITING_CONFIRM, GEN_3D, COMPLETED, FAILED
  mascotTaskId     String?  // Meshy ä»»åŠ¡ID
  
  // --- ğŸ’° é¢åº¦æ§åˆ¶ ---
  creditsTextToImage Int    @default(3) // å‰©ä½™è®¾è®¡æ¬¡æ•° (é»˜è®¤3)
  creditsImageTo3D   Int    @default(1) // å‰©ä½™å»ºæ¨¡æ¬¡æ•° (é»˜è®¤1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==========================================
// ğŸ’ è™šæ‹Ÿèµ„äº§ä¸åº“å­˜ç³»ç»Ÿ (Inventory System)
// ==========================================

// 1. èµ„äº§æ¨¡æ¿è¡¨ (ä»…å®˜æ–¹èµ„äº§ä½¿ç”¨ï¼Œå®šä¹‰ SKU)
model AssetTemplate {
  id          Int       @id // è‡ªå®šä¹‰ID (å¦‚ 100001)
  name        String    // æ¨¡æ¿åç§° (å¦‚ "å·¨é¾™ä¼ è¯´")
  description String?   @db.Text
  type        String    // ç±»åˆ«: WEAPON, CHARACTER, BADGE, TROPHY
  
  isTradable  Boolean   @default(false) // æ˜¯å¦å…è®¸äº¤æ˜“
  rarity      String    @default("COMMON") // ç¨€æœ‰åº¦: COMMON, RARE, EPIC, LEGENDARY
  
  // å®˜æ–¹èµ„äº§ç»Ÿä¸€ä½¿ç”¨çš„èµ„æºè·¯å¾„
  modelPath   String    // .glb æ–‡ä»¶è·¯å¾„
  imagePath   String    // .png ç¼©ç•¥å›¾è·¯å¾„

  // å…³è”æ‰€æœ‰åŸºäºæ­¤æ¨¡æ¿ç”Ÿæˆçš„å®ä¾‹
  instances   UserAsset[] 
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// 2. èµ„äº§å®ä¾‹è¡¨ (å®é™…å­˜åœ¨çš„ç‰©å“)
model UserAsset {
  // UID è§„åˆ™: 
  // å®˜æ–¹: æ¨¡æ¿ID(6ä½) + éšæœº(6ä½) = 12ä½
  // è‡ªåˆ¶: 999999 + éšæœº(6ä½) = 12ä½
  uid         String    @id 
  
  // --- æ¥æºåŒºåˆ† ---
  isOfficial  Boolean   @default(false) // true=å®˜æ–¹å‘æ”¾, false=ç©å®¶è‡ªåˆ¶
  templateId  Int?      // å…³è”æ¨¡æ¿ (ä»…å®˜æ–¹)
  template    AssetTemplate? @relation(fields: [templateId], references: [id])
  
  // --- è‡ªåˆ¶èµ„äº§ç‰¹æœ‰å­—æ®µ ---
  customName  String?   // ç©å®¶ç»™è‡ªåˆ¶ç‰©å“èµ·çš„åå­—
  customDescription String?   @db.Text  // ğŸ‘ˆ ç¡®ä¿è¿™è¡Œå­˜åœ¨ï¼è¿™æ˜¯æˆ‘ä»¬è¦åŠ çš„æ–°å­—æ®µ
  modelPath   String?   // è‡ªåˆ¶æ¨¡å‹çš„è·¯å¾„ (å®˜æ–¹èµ„äº§ä¸ºç©ºï¼Œè¯»æ¨¡æ¿çš„)
  imagePath   String?   // è‡ªåˆ¶ç¼©ç•¥å›¾ (å®˜æ–¹èµ„äº§ä¸ºç©ºï¼Œè¯»æ¨¡æ¿çš„)
  
  // --- å½’å±æƒ (å¤šæ€ï¼šå±äºäºº æˆ– å±äºæˆ˜é˜Ÿ) ---
  ownerId     String?   // å½“å‰æŒæœ‰äºº ID
  owner       User?     @relation(fields: [ownerId], references: [id])
  
  ownerTeamId Int?      // å½“å‰æŒæœ‰æˆ˜é˜Ÿ ID (ç”¨äºæˆ˜é˜Ÿå¥–æ¯/è£èª‰)
  ownerTeam   EsportsTeam? @relation(fields: [ownerTeamId], references: [id])
  
  // --- å±•ç¤ºè®¾ç½® ---
  isShowcased Boolean   @default(false) // æ˜¯å¦åœ¨ä¸»é¡µå±•æŸœæ˜¾ç¤º (é™åˆ¶5ä¸ª)
  
  // --- æº¯æºä¸çŠ¶æ€ ---
  creatorId   String?   // åˆå§‹åˆ›å»ºè€…/ç¬¬ä¸€ä»»ä¸»äºº (ç”¨äºå›æ”¶é€»è¾‘)
  status      String    @default("NORMAL") // NORMAL, LOCKED(äº¤æ˜“ä¸­), BURNED(é”€æ¯)
  
  // --- å†å²è®°å½• ---
  history     AssetTransferLog[] 

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([ownerId])
  @@index([ownerTeamId])
  @@index([templateId])
}

// 3. èµ„äº§æµè½¬æ—¥å¿— (ç”¨äºè¿½æº¯)
model AssetTransferLog {
  id          Int       @id @default(autoincrement())
  
  assetUid    String
  asset       UserAsset @relation(fields: [assetUid], references: [uid], onDelete: Cascade)
  
  fromUserId  String?   // å‘é€æ–¹ (ç©ºä»£è¡¨ç³»ç»Ÿå‘æ”¾)
  toUserId    String?   // æ¥æ”¶æ–¹ (ç©ºä»£è¡¨å›æ”¶/é”€æ¯)
  
  type        String    // ISSUE(å‘æ”¾), TRANSFER(äº¤æ˜“), REVOKE(æ’¤é”€), GENERATE(è‡ªåˆ¶)
  price       String?   // é¢„ç•™ï¼šå¦‚æœæœ‰äº¤æ˜“é‡‘é¢
  
  timestamp   DateTime  @default(now())
}

// 4. ç”Ÿæˆä»»åŠ¡è¡¨ (ç”¨äºå¤„ç† Meshy-5 å¼‚æ­¥ç”Ÿæˆ)
model GenerationTask {
  id            String   @id @default(uuid())
  meshyTaskId   String   @unique // Meshy è¿”å›çš„ä»»åŠ¡ ID
  
  type          String   // 'TEXT_TO_3D' | 'IMAGE_TO_3D'
  status        String   @default("PENDING") // PENDING, IN_PROGRESS, SUCCEEDED, FAILED, DOWNLOADED
  progress      Int      @default(0)
  
  // è¾“å…¥è®°å½•
  prompt        String?  @db.Text
  sourceImageUrl String? // ä¸Šä¼ çš„åŸå›¾è·¯å¾„
  
  // å½’å±
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  // ç»“æœå…³è”
  resultAssetUid String? // ç”ŸæˆæˆåŠŸåå…³è”çš„èµ„äº§ UID

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}